<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>meloetta</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;1,400&display=swap');

:root {
  /* light theme (warm parchment) */
  --bg: #f4efe6;
  --bg-raised: #eaeaea;
  --bg-surface: #e0e0e0;
  --border: #d2cbbf;
  --border-soft: #ddd7cc;
  --phosphor: #584528;
  --phosphor-dim: #a89878;
  --phosphor-bright: #5a4828;
  --phosphor-glow: rgba(122, 101, 64, 0.06);
  --text: #6a5c48;
  --text-dim: #a09480;
  --text-dimmer: #c0b4a4;
  --text-bright: #000000;
  --red: #a84a38;
  --red-dim: #d4a898;
  --red-bg: #f0d4cc;
  --green: #5a7830;
  --green-dim: #a0b888;
  --green-bg: #d4e8c8;
  --blue: #5a7090;
  --yellow: #8a7430;
  --diff-add-text: #3a6820;
  --diff-del-text: #983828;
  --hunk-bg: rgba(90, 112, 144, 0.06);
  --hunk-border: rgba(90, 112, 144, 0.12);
  --badge-mod-bg: rgba(90, 112, 144, 0.1);
  --badge-rename-bg: rgba(138, 116, 48, 0.1);
  --selection-bg: rgba(122, 101, 64, 0.15);
  --scanline-opacity: 0;
  --sp-1: 2px;
  --sp-2: 4px;
  --sp-3: 8px;
  --sp-4: 12px;
  --sp-5: 16px;
  --sp-6: 20px;
  --font: 'IBM Plex Mono', 'SF Mono', 'Menlo', 'Consolas', monospace;
  --font-sm: 11px;
  --font-base: 13px;
  --font-lg: 14px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0c0a06;
    --bg-raised: #100e0a;
    --bg-surface: #15120e;
    --border: #1e1a14;
    --border-soft: #181510;
    --phosphor: #b8a070;
    --phosphor-dim: #7a6848;
    --phosphor-bright: #d4c4a0;
    --phosphor-glow: rgba(184, 160, 112, 0.08);
    --text: #9a8868;
    --text-dim: #5c4e3a;
    --text-dimmer: #3a3228;
    --text-bright: #ddd0b4;
    --red: #b85c4a;
    --red-dim: #6a3a2e;
    --red-bg: #1a110e;
    --green: #8a9a50;
    --green-dim: #4a5c2e;
    --green-bg: #12140c;
    --blue: #8a9ab0;
    --yellow: #b8a44a;
    --diff-add-text: #b4c888;
    --diff-del-text: #c88a7a;
    --hunk-bg: rgba(138, 154, 176, 0.06);
    --hunk-border: rgba(138, 154, 176, 0.1);
    --badge-mod-bg: rgba(138, 154, 176, 0.15);
    --badge-rename-bg: rgba(184, 164, 74, 0.1);
    --selection-bg: rgba(184, 160, 112, 0.2);
    --scanline-opacity: 1;
  }
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  font-size: var(--font-base);
  -webkit-font-smoothing: antialiased;
}
/* CRT scanline texture (dark mode only) */
body::after {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  opacity: var(--scanline-opacity);
  background: repeating-linear-gradient(
    to bottom,
    transparent 0px,
    transparent 2px,
    rgba(0, 0, 0, 0.04) 2px,
    rgba(0, 0, 0, 0.04) 4px
  );
}
::selection { background: var(--selection-bg); color: var(--text-bright); }
a { color: var(--text-dim); text-decoration: none; }
a:hover { color: var(--phosphor); }
button {
  background: var(--bg-raised);
  color: var(--text);
  border: 1px solid var(--border);
  padding: var(--sp-2) var(--sp-4);
  font-family: var(--font);
  font-size: var(--font-sm);
  cursor: pointer;
  min-height: 36px;
  border-radius: 2px;
  transition: background 0.15s, color 0.15s, border-color 0.15s;
}
button:hover { background: var(--bg-surface); color: var(--phosphor-bright); border-color: var(--phosphor-dim); }

#app { position: fixed; left: 0; top: 0; right: 0; bottom: 0; display: flex; flex-direction: column; }

/* ==================== LIST VIEW ==================== */
.list-header {
  padding: var(--sp-3) var(--sp-4);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.list-header h1 {
  font-size: var(--font-sm);
  font-weight: 400;
  color: var(--text-dim);
  letter-spacing: 2px;
  text-transform: uppercase;
}
#create-btn {
  padding: var(--sp-2) var(--sp-4);
  font-size: var(--font-sm);
  letter-spacing: 0.5px;
}
.session-list { flex: 1; overflow-y: auto; padding: var(--sp-1); }
.session-item {
  padding: var(--sp-3) var(--sp-4);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: var(--sp-1);
  min-height: 36px;
  border-radius: 2px;
  position: relative;
  transition: background 0.15s;
  border-bottom: 1px solid var(--border-soft);
}
.session-item:hover { background: var(--bg-raised); }
.session-title {
  color: var(--phosphor);
  font-size: var(--font-base);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding-right: 28px;
}
.session-info {
  display: flex;
  align-items: center;
  gap: var(--sp-3);
  flex-shrink: 0;
}
.session-cli {
  color: var(--text-dim);
  font-size: 10px;
  border: 1px solid var(--border);
  padding: 0 var(--sp-2);
  border-radius: 1px;
}
.session-cwd {
  color: var(--text-dimmer);
  font-size: var(--font-sm);
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.session-meta { color: var(--text-dimmer); font-size: var(--font-sm); }
.session-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.session-dot.alive { background: var(--green); box-shadow: 0 0 4px var(--green); }
.session-dot.dead { background: var(--text-dimmer); }
.session-delete {
  position: absolute;
  right: var(--sp-4);
  top: 50%;
  transform: translateY(-50%);
  opacity: 0;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 14px;
  cursor: pointer;
  padding: var(--sp-1) var(--sp-2);
  min-height: auto;
  border-radius: 2px;
  transition: opacity 0.15s, color 0.15s;
}
.session-item:hover .session-delete { opacity: 1; }
.session-delete:hover { color: var(--red); background: var(--red-bg); }
.empty { padding: var(--sp-6) var(--sp-4); color: var(--text-dimmer); text-align: center; font-size: var(--font-sm); }

/* ==================== CHAT VIEW ==================== */
.chat-header {
  display: flex;
  align-items: stretch;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
  flex-shrink: 0;
  position: relative;
}
.chat-header .back {
  color: var(--text);
  cursor: pointer;
  font-size: var(--font-base);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 var(--sp-5);
  min-height: 40px;
  border: none;
  border-right: 1px solid var(--border);
  background: none;
  border-radius: 0;
  transition: color 0.15s, background 0.15s;
}
.chat-header .back:hover { color: var(--phosphor-bright); background: var(--bg-raised); }
.chat-header .spacer { flex: 1; }
.header-menu {
  background: none;
  border: none;
  border-left: 1px solid var(--border);
  color: var(--text);
  font-size: var(--font-base);
  cursor: pointer;
  padding: 0 var(--sp-5);
  min-height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0;
  letter-spacing: 2px;
  transition: color 0.15s, background 0.15s;
}
.header-menu:hover { color: var(--phosphor-bright); background: var(--bg-raised); }
.header-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
  z-index: 20;
  padding: var(--sp-2);
  overflow: hidden;
}
.header-dropdown .dropdown-info {
  padding: var(--sp-3) var(--sp-3);
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: var(--sp-2);
}
.header-dropdown .dropdown-title {
  color: var(--phosphor);
  font-size: var(--font-base);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.header-dropdown .dropdown-cwd {
  color: var(--text-dimmer);
  font-size: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.header-dropdown .dropdown-cli-badge {
  display: inline-block;
  color: var(--text-dim);
  font-size: 10px;
  border: 1px solid var(--border);
  padding: 0 var(--sp-2);
  border-radius: 1px;
  width: fit-content;
}
.header-dropdown button {
  display: block;
  width: 100%;
  text-align: left;
  background: none;
  border: none;
  color: var(--text);
  padding: var(--sp-3);
  font-size: var(--font-sm);
  min-height: auto;
  border-radius: 2px;
}
.header-dropdown button:hover { background: var(--bg-raised); color: var(--phosphor-bright); }
.header-dropdown .dropdown-delete:hover { color: var(--red); background: var(--red-bg); }
.header-dropdown .dropdown-changes { display: none; }
.header-dropdown .dropdown-changes.visible { display: block; }

.messages {
  flex: 1;
  overflow-y: auto;
  padding: var(--sp-4);
}
.msg {
  margin-bottom: var(--sp-4);
  white-space: pre-wrap;
  word-wrap: break-word;
  font-size: var(--font-base);
  line-height: 1.5;
}
.msg.user { color: var(--text-bright); }
.msg.user::before { content: "> "; color: var(--text-dimmer); }
.msg.assistant { color: var(--phosphor); padding-left: var(--sp-4); }
.msg.streaming { opacity: 0.7; }

/* tool items (inline) */
.tool-item {
  padding-left: var(--sp-4);
  font-size: var(--font-sm);
  color: var(--text-dimmer);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: var(--sp-1);
  line-height: 1.4;
}
.tool-item::before { content: "~ "; color: var(--border); }

/* input area */
.input-area {
  display: flex;
  align-items: stretch;
  border-top: 1px solid var(--border);
  background: var(--bg);
  flex-shrink: 0;
  padding-bottom: env(safe-area-inset-bottom, 0);
}
.input-area textarea {
  flex: 1;
  background: var(--bg-raised);
  color: var(--phosphor-bright);
  border: none;
  padding: var(--sp-3) var(--sp-4);
  font-family: var(--font);
  font-size: var(--font-lg);
  resize: none;
  min-height: 40px;
  max-height: 120px;
  border-radius: 0;
  overflow-y: auto;
  caret-color: var(--phosphor);
}
.input-area textarea:focus { outline: none; background: var(--bg-surface); }
.input-area textarea::placeholder { color: var(--text-dimmer); }
.input-area textarea:disabled { opacity: 0.3; cursor: not-allowed; }
#send-btn {
  border: none;
  border-left: 1px solid var(--border);
  border-radius: 0;
  padding: var(--sp-3) var(--sp-5);
  min-height: 40px;
  font-size: var(--font-base);
}
#send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

/* ==================== FOLDER PICKER ==================== */
.picker-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
.picker {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  width: 500px;
  max-width: calc(100vw - 16px);
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  border-radius: 2px;
  overflow: hidden;
}
.picker-header {
  padding: var(--sp-3) var(--sp-4);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.picker-header span { color: var(--text-dim); font-size: var(--font-sm); }
.picker-path {
  padding: var(--sp-3) var(--sp-4);
  color: var(--text-dimmer);
  font-size: var(--font-sm);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: var(--sp-3);
}
.picker-path .cur {
  color: var(--text);
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  direction: rtl;
  text-align: left;
}
.picker-entries { flex: 1; overflow-y: auto; max-height: 400px; padding: var(--sp-1); }
.picker-entry {
  padding: var(--sp-2) var(--sp-4);
  cursor: pointer;
  color: var(--text);
  min-height: 36px;
  display: flex;
  align-items: center;
  border-radius: 2px;
  transition: background 0.15s;
  font-size: var(--font-sm);
}
.picker-entry:hover { background: var(--bg-raised); color: var(--phosphor); }
.picker-entry::before { content: "/ "; color: var(--text-dimmer); }
.picker-actions {
  padding: var(--sp-3) var(--sp-4);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--sp-3);
}
.cli-toggle { display: flex; gap: 0; }
.cli-toggle button { border-radius: 0; border-right: none; }
.cli-toggle button:first-child { border-radius: 2px 0 0 2px; }
.cli-toggle button:last-child { border-radius: 0 2px 2px 0; border-right: 1px solid var(--border); }
.cli-toggle button.active { background: var(--phosphor-dim); color: var(--bg); }

/* ==================== DIFF OVERLAY ==================== */
.diff-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 100;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.diff-toolbar {
  padding: var(--sp-3) var(--sp-4);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: var(--sp-3);
  flex-shrink: 0;
}
.diff-toolbar .diff-close {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 16px;
  cursor: pointer;
  padding: var(--sp-1) var(--sp-2);
  min-height: auto;
  border-radius: 2px;
}
.diff-toolbar .diff-close:hover { color: var(--phosphor-bright); background: var(--bg-raised); }
.diff-toolbar .diff-title { color: var(--phosphor); font-weight: 400; font-size: var(--font-base); }
.diff-toolbar .diff-stat { color: var(--text-dim); font-size: var(--font-sm); }
.diff-toolbar .diff-stat .add { color: var(--green); }
.diff-toolbar .diff-stat .del { color: var(--red); }

.diff-chips {
  padding: var(--sp-2) var(--sp-4);
  border-bottom: 1px solid var(--border-soft);
  display: flex;
  gap: var(--sp-2);
  flex-wrap: nowrap;
  flex-shrink: 0;
  overflow-x: auto;
  overflow-y: hidden;
}
.diff-chip {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 10px;
  padding: var(--sp-1) var(--sp-3);
  border-radius: 1px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  flex-shrink: 0;
  white-space: nowrap;
}
.diff-chip:hover { background: var(--bg-surface); color: var(--phosphor); border-color: var(--phosphor-dim); }

.diff-body { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: var(--sp-6); min-height: 0; }

.diff-file { border-bottom: 1px solid var(--border-soft); overflow: hidden; }
.diff-file-header {
  position: sticky;
  top: 0;
  background: var(--bg-raised);
  padding: var(--sp-2) var(--sp-4);
  display: flex;
  align-items: center;
  gap: var(--sp-3);
  cursor: pointer;
  z-index: 5;
  border-bottom: 1px solid var(--border);
}
.diff-file-header:hover { background: var(--bg-surface); }
.diff-file-header .arrow { color: var(--text-dim); font-size: 9px; transition: transform 0.15s; width: 12px; }
.diff-file-header .arrow.collapsed { transform: rotate(-90deg); }
.diff-file-header .fname { color: var(--phosphor); font-size: var(--font-sm); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
.diff-file-header .badge {
  font-size: 9px;
  padding: 0 var(--sp-2);
  border-radius: 1px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  flex-shrink: 0;
}
.badge-modified { background: var(--badge-mod-bg); color: var(--blue); }
.badge-added, .badge-untracked { background: var(--green-bg); color: var(--green); }
.badge-deleted { background: var(--red-bg); color: var(--red); }
.badge-renamed { background: var(--badge-rename-bg); color: var(--yellow); }
.badge-binary { background: var(--bg-surface); color: var(--text-dim); }
.diff-file-header .fstat { margin-left: auto; font-size: 10px; color: var(--text-dim); flex-shrink: 0; }
.diff-file-header .fstat .add { color: var(--green); }
.diff-file-header .fstat .del { color: var(--red); }

.diff-hunks { font-size: var(--font-sm); }
.diff-hunks.hidden { display: none; }
.diff-hunk-header {
  background: var(--hunk-bg);
  color: var(--blue);
  padding: var(--sp-1) var(--sp-4);
  font-size: 10px;
  border-top: 1px solid var(--hunk-border);
}
.diff-line { display: flex; line-height: 18px; }
.diff-line .ln { width: 40px; text-align: right; padding-right: var(--sp-2); color: var(--text-dimmer); flex-shrink: 0; user-select: none; font-size: 10px; }
.diff-line .lc { flex: 1; padding: 0 var(--sp-3); white-space: pre-wrap; word-break: break-all; tab-size: 4; min-width: 0; overflow: hidden; }
.diff-line.ctx { background: transparent; }
.diff-line.ctx .lc { color: var(--text); }
.diff-line.add { background: var(--green-bg); }
.diff-line.add .ln { color: var(--green-dim); }
.diff-line.add .lc { color: var(--diff-add-text); }
.diff-line.del { background: var(--red-bg); }
.diff-line.del .ln { color: var(--red-dim); }
.diff-line.del .lc { color: var(--diff-del-text); }
.diff-truncated { padding: var(--sp-3) var(--sp-4); color: var(--text-dimmer); font-size: var(--font-sm); font-style: italic; }
.diff-empty { padding: var(--sp-6); color: var(--text-dimmer); text-align: center; font-size: var(--font-base); }
.diff-loading { padding: var(--sp-6); color: var(--text-dim); text-align: center; font-size: var(--font-base); }

/* ==================== MOBILE ==================== */
@media (max-width: 600px) {
  .session-list { padding: var(--sp-1); }
  .session-item { padding: var(--sp-3); }
  .session-info { width: 100%; flex-wrap: wrap; gap: var(--sp-2); }
  .session-cwd { max-width: 100%; }
  .session-delete { opacity: 1; }
  .messages { padding: var(--sp-3); }
  .msg.assistant { padding-left: var(--sp-3); }
  .tool-item { padding-left: var(--sp-3); }
  .input-area textarea { font-size: 16px; }
  .picker-actions { flex-direction: column; gap: var(--sp-3); }
  .picker-actions .picker-select { width: 100%; }
}
</style>
</head>
<body>
<div id="app"></div>
<script>
const app = document.getElementById("app");
let ws = null;
let currentSession = null;
let streaming = false;
let streamEl = null;
let toolCount = 0;
let lastToolEl = null;
let pickerCli = "claude";
let sessionIsGit = false;
let sessionTitle = "";
let sessionCwd = "";
let sessionCli = "";

function connect() {
  const proto = location.protocol === "https:" ? "wss:" : "ws:";
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => route();
  ws.onmessage = (e) => handle(JSON.parse(e.data));
  ws.onclose = () => setTimeout(connect, 1000);
}

function send(msg) { ws.send(JSON.stringify(msg)); }

function route() {
  if (currentSession) {
    send({ type: "leave", sessionId: currentSession });
    currentSession = null;
  }
  const hash = location.hash || "#/";
  if (hash.startsWith("#/session/")) {
    const id = hash.slice(10);
    openChat(id);
  } else {
    showList();
  }
}

window.addEventListener("hashchange", route);

// --- List view ---
function showList() {
  currentSession = null;
  send({ type: "list" });
}

function renderList(sessions) {
  if (location.hash && location.hash !== "#/") return;
  app.innerHTML = `
    <div class="list-header">
      <h1>meloetta</h1>
      <button id="create-btn">+ new</button>
    </div>
    <div class="session-list" id="slist"></div>
  `;
  const list = document.getElementById("slist");
  if (!sessions.length) {
    list.innerHTML = '<div class="empty">no sessions</div>';
  } else {
    sessions.sort((a, b) => b.createdAt - a.createdAt);
    list.innerHTML = sessions.map(s => `
      <div class="session-item" data-id="${s.id}">
        <span class="session-title">${esc(s.title)}</span>
        <div class="session-info">
          <span class="session-cli">${esc(s.cli)}</span>
          <span class="session-cwd">${esc(s.cwd)}</span>
          <span class="session-meta">${ago(s.createdAt)}</span>
          <span class="session-dot ${s.alive ? 'alive' : 'dead'}"></span>
        </div>
        <button class="session-delete" title="Delete session">&times;</button>
      </div>
    `).join("");
    list.querySelectorAll(".session-item").forEach(el => {
      el.onclick = () => { location.hash = `#/session/${el.dataset.id}`; };
    });
    list.querySelectorAll(".session-delete").forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const id = btn.closest(".session-item").dataset.id;
        send({ type: "delete", sessionId: id });
        btn.closest(".session-item").remove();
      };
    });
  }
  document.getElementById("create-btn").onclick = () => openPicker();
}

// --- Folder picker ---
function openPicker() {
  send({ type: "browse" });
}

function renderPicker(path, entries) {
  let overlay = document.querySelector(".picker-overlay");
  if (!overlay) {
    overlay = document.createElement("div");
    overlay.className = "picker-overlay";
    document.body.appendChild(overlay);
  }

  const isRoot = path === "/";
  overlay.innerHTML = `
    <div class="picker">
      <div class="picker-header">
        <span>select folder</span>
        <button class="picker-close">cancel</button>
      </div>
      <div class="picker-path">
        ${isRoot ? '' : '<button class="picker-up">..</button>'}
        <span class="cur">${esc(path)}</span>
      </div>
      <div class="picker-entries">${
        entries.length
          ? entries.map(e => `<div class="picker-entry" data-name="${esc(e.name)}">${esc(e.name)}</div>`).join("")
          : '<div class="empty">empty</div>'
      }</div>
      <div class="picker-actions">
        <div class="cli-toggle">
          <button class="cli-btn ${pickerCli === 'claude' ? 'active' : ''}" data-cli="claude">claude</button>
          <button class="cli-btn ${pickerCli === 'codex' ? 'active' : ''}" data-cli="codex">codex</button>
        </div>
        <button class="picker-select">start session</button>
      </div>
    </div>
  `;

  overlay.querySelector(".picker-close").onclick = () => overlay.remove();
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

  const upBtn = overlay.querySelector(".picker-up");
  if (upBtn) {
    upBtn.onclick = () => {
      const parent = path.replace(/\/[^/]+\/?$/, "") || "/";
      send({ type: "browse", path: parent });
    };
  }

  overlay.querySelectorAll(".picker-entry").forEach(el => {
    el.onclick = () => {
      const sub = path === "/" ? `/${el.dataset.name}` : `${path}/${el.dataset.name}`;
      send({ type: "browse", path: sub });
    };
  });

  overlay.querySelectorAll(".cli-btn").forEach(btn => {
    btn.onclick = () => {
      pickerCli = btn.dataset.cli;
      overlay.querySelectorAll(".cli-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    };
  });

  overlay.querySelector(".picker-select").onclick = () => {
    overlay.remove();
    send({ type: "create", cwd: path, cli: pickerCli });
  };
}

// --- Chat view ---
function openChat(id) {
  currentSession = id;
  streaming = false;
  streamEl = null;
  toolCount = 0;
  lastToolEl = null;
  sessionIsGit = false;
  sessionTitle = "";
  sessionCwd = "";
  sessionCli = "";
  app.innerHTML = `
    <div class="chat-header">
      <button class="back" id="back-btn">back</button>
      <div class="spacer"></div>
      <button class="header-menu" id="menu-btn">more</button>
    </div>
    <div class="messages" id="msgs"></div>
    <div class="input-area">
      <textarea id="input" rows="1" placeholder="message..."></textarea>
      <button id="send-btn">send</button>
    </div>
  `;
  document.getElementById("back-btn").onclick = () => { location.hash = "#/"; };

  // Header dropdown menu
  document.getElementById("menu-btn").onclick = (e) => {
    e.stopPropagation();
    toggleMenu();
  };

  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send-btn");
  const sendMsg = () => {
    const text = input.value.trim();
    if (!text || streaming) return;
    send({ type: "message", sessionId: currentSession, text });
    appendMsg("user", text);
    input.value = "";
    input.style.height = "auto";
    streaming = true;
    streamEl = null;
    toolCount = 0;
    lastToolEl = null;
    input.disabled = true;
    sendBtn.disabled = true;
  };
  sendBtn.onclick = sendMsg;
  input.addEventListener("keydown", (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === "Enter") { e.preventDefault(); sendMsg(); }
  });
  input.addEventListener("input", () => {
    input.style.height = "auto";
    input.style.height = input.scrollHeight + "px";
  });

  send({ type: "open", sessionId: id });
}

function toggleMenu() {
  const existing = document.querySelector(".header-dropdown");
  if (existing) { existing.remove(); return; }

  const header = document.querySelector(".chat-header");
  const dropdown = document.createElement("div");
  dropdown.className = "header-dropdown";
  dropdown.innerHTML = `
    <div class="dropdown-info">
      <span class="dropdown-title">${esc(sessionTitle || currentSession)}</span>
      <span class="dropdown-cwd">${esc(sessionCwd)}</span>
      <span class="dropdown-cli-badge">${esc(sessionCli || "claude")}</span>
    </div>
    <button class="dropdown-changes ${sessionIsGit ? 'visible' : ''}">changes</button>
    <button class="dropdown-delete">delete session</button>
  `;
  header.appendChild(dropdown);

  dropdown.querySelector(".dropdown-changes").onclick = (e) => {
    e.stopPropagation();
    dropdown.remove();
    send({ type: "git_diff", sessionId: currentSession });
    showDiffOverlay(null);
  };

  dropdown.querySelector(".dropdown-delete").onclick = (e) => {
    e.stopPropagation();
    send({ type: "delete", sessionId: currentSession });
    location.hash = "#/";
  };

  const closeMenu = (e) => {
    if (!dropdown.contains(e.target) && e.target.id !== "menu-btn") {
      dropdown.remove();
      document.removeEventListener("click", closeMenu);
    }
  };
  setTimeout(() => document.addEventListener("click", closeMenu), 0);
}

function isNearBottom() {
  const msgs = document.getElementById("msgs");
  if (!msgs) return true;
  return msgs.scrollHeight - msgs.scrollTop - msgs.clientHeight < 50;
}

function appendMsg(role, text) {
  const msgs = document.getElementById("msgs");
  if (!msgs) return;
  const atBottom = isNearBottom();
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.textContent = text;
  msgs.appendChild(div);
  if (atBottom) msgs.scrollTop = msgs.scrollHeight;
  return div;
}

// --- Tool summarization ---
function summarizeTool(name, argsJson) {
  try {
    const input = JSON.parse(argsJson);
    if (name === "Bash" && input.description) return `${name}: ${input.description}`;
    if (name === "Bash" && input.command) return `${name}: ${input.command.slice(0, 80)}`;
    if (name === "Read" && input.file_path) return `${name}: ${input.file_path}`;
    if (name === "Edit" && input.file_path) return `${name}: ${input.file_path}`;
    if (name === "Write" && input.file_path) return `${name}: ${input.file_path}`;
    if (name === "Grep" && input.pattern) return `${name}: ${input.pattern}`;
    if (name === "Glob" && input.pattern) return `${name}: ${input.pattern}`;
    if (name === "WebSearch" && input.query) return `${name}: ${input.query}`;
    if (name === "WebFetch" && input.url) return `${name}: ${input.url}`;
    if (name === "Task" && input.description) return `${name}: ${input.description}`;
    if (name === "command_execution" && input.command) return `running: ${input.command.slice(0, 80)}`;
    return name;
  } catch {
    return name;
  }
}


function endStreaming() {
  if (streamEl) streamEl.classList.remove("streaming");
  streamEl = null;
  lastToolEl = null;
  toolCount = 0;
  streaming = false;
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send-btn");
  if (input) { input.disabled = false; input.focus(); }
  if (sendBtn) sendBtn.disabled = false;
}

// --- handle server messages ---
function handle(msg) {
  switch (msg.type) {
    case "sessions":
      renderList(msg.sessions);
      break;

    case "created":
      location.hash = `#/session/${msg.session.id}`;
      break;

    case "history": {
      sessionTitle = msg.title || currentSession;
      sessionCwd = msg.cwd || "";
      sessionCli = msg.cli || "claude";
      for (const m of msg.messages) appendMsg(m.role, m.text);
      sessionIsGit = !!msg.isGit;
      break;
    }

    case "response.created":
      break;

    case "response.in_progress":
      break;

    case "response.output_item.added": {
      if (!msg.item) break;
      const msgs = document.getElementById("msgs");
      if (!msgs) break;
      const atBottom = isNearBottom();
      // Finalize current text stream so subsequent deltas create a new div after this item
      if (streamEl) { streamEl.classList.remove("streaming"); streamEl = null; }
      if (msg.item.type === "reasoning") {
        const item = document.createElement("div");
        item.className = "tool-item";
        item.textContent = "thinking...";
        msgs.appendChild(item);
        lastToolEl = item;
      } else if (msg.item.type === "function_call") {
        const summary = summarizeTool(msg.item.name, msg.item.arguments || "{}");
        const item = document.createElement("div");
        item.className = "tool-item";
        item.textContent = summary;
        msgs.appendChild(item);
        lastToolEl = item;
        toolCount++;
      }
      if (atBottom) msgs.scrollTop = msgs.scrollHeight;
      break;
    }

    case "response.output_item.done":
      break;

    case "response.output_text.delta": {
      const msgs = document.getElementById("msgs");
      if (!msgs) break;
      const atBottom = isNearBottom();
      if (!streamEl) {
        streamEl = document.createElement("div");
        streamEl.className = "msg assistant streaming";
        msgs.appendChild(streamEl);
      }
      streamEl.textContent += msg.delta;
      if (atBottom) msgs.scrollTop = msgs.scrollHeight;
      break;
    }

    case "response.output_text.done": {
      if (streamEl) streamEl.classList.remove("streaming");
      streamEl = null;
      break;
    }

    case "response.completed":
      endStreaming();
      break;

    case "response.failed": {
      endStreaming();
      break;
    }

    case "error":
      break;

    case "closed":
      break;

    case "git_diff_result":
      renderDiffOverlay(msg.stats, msg.files);
      break;

    case "browse_result":
      if (msg.defaults) pickerCli = msg.defaults.cli || "claude";
      renderPicker(msg.path, msg.entries);
      break;

    case "deleted":
      if (location.hash === "#/" || !location.hash) send({ type: "list" });
      break;
  }
}

// --- Diff overlay ---
function showDiffOverlay(data) {
  let overlay = document.querySelector(".diff-overlay");
  if (!overlay) {
    overlay = document.createElement("div");
    overlay.className = "diff-overlay";
    document.body.appendChild(overlay);
  }
  if (!data) {
    overlay.innerHTML = '<div class="diff-loading">loading changes...</div>';
  }
}

function closeDiffOverlay() {
  const overlay = document.querySelector(".diff-overlay");
  if (overlay) overlay.remove();
}

function renderDiffOverlay(stats, files) {
  let overlay = document.querySelector(".diff-overlay");
  if (!overlay) {
    overlay = document.createElement("div");
    overlay.className = "diff-overlay";
    document.body.appendChild(overlay);
  }

  if (!files.length) {
    overlay.innerHTML = `
      <div class="diff-toolbar">
        <button class="diff-close" id="diff-close">&times;</button>
        <span class="diff-title">uncommitted changes</span>
      </div>
      <div class="diff-empty">no uncommitted changes</div>
    `;
    overlay.querySelector("#diff-close").onclick = closeDiffOverlay;
    return;
  }

  // Compute per-file stats
  const fileStats = files.map(f => {
    let a = 0, d = 0;
    for (const h of f.hunks) for (const l of h.lines) {
      if (l.type === "addition") a++;
      else if (l.type === "deletion") d++;
    }
    return { add: a, del: d };
  });

  const toolbarHtml = `
    <div class="diff-toolbar">
      <button class="diff-close" id="diff-close">&times;</button>
      <span class="diff-title">uncommitted changes</span>
      <span class="diff-stat">${stats.files} file${stats.files !== 1 ? "s" : ""} <span class="add">+${stats.additions}</span> <span class="del">-${stats.deletions}</span></span>
    </div>
  `;

  const chipsHtml = `
    <div class="diff-chips">
      ${files.map((f, i) => `<span class="diff-chip" data-idx="${i}">${esc(f.path.split("/").pop())}</span>`).join("")}
    </div>
  `;

  const filesHtml = files.map((f, i) => {
    const fs = fileStats[i];
    const badgeClass = "badge-" + f.status;
    const statStr = (fs.add || fs.del) ? `<span class="fstat"><span class="add">+${fs.add}</span> <span class="del">-${fs.del}</span></span>` : "";

    let hunksHtml = "";
    for (const hunk of f.hunks) {
      hunksHtml += `<div class="diff-hunk-header">${esc(hunk.header)}</div>`;
      for (const line of hunk.lines) {
        const cls = line.type === "addition" ? "add" : line.type === "deletion" ? "del" : "ctx";
        const oldN = line.oldNum != null ? line.oldNum : "";
        const newN = line.newNum != null ? line.newNum : "";
        const marker = line.type === "addition" ? "+" : line.type === "deletion" ? "-" : " ";
        hunksHtml += `<div class="diff-line ${cls}"><span class="ln">${oldN}</span><span class="ln">${newN}</span><span class="lc">${marker}${esc(line.content)}</span></div>`;
      }
    }
    if (f.truncated) {
      hunksHtml += `<div class="diff-truncated">file truncated (too large to display fully)</div>`;
    }
    if (f.status === "binary") {
      hunksHtml += `<div class="diff-truncated">binary file</div>`;
    }

    return `
      <div class="diff-file" id="diff-file-${i}">
        <div class="diff-file-header" data-idx="${i}">
          <span class="arrow">&#9660;</span>
          <span class="fname">${esc(f.path)}</span>
          <span class="badge ${badgeClass}">${f.status}</span>
          ${statStr}
        </div>
        <div class="diff-hunks" data-idx="${i}">${hunksHtml}</div>
      </div>
    `;
  }).join("");

  overlay.innerHTML = toolbarHtml + chipsHtml + `<div class="diff-body">${filesHtml}</div>`;

  // Wire close button
  overlay.querySelector("#diff-close").onclick = closeDiffOverlay;

  // Wire file chips â†’ scroll to file
  overlay.querySelectorAll(".diff-chip").forEach(chip => {
    chip.onclick = () => {
      const idx = chip.dataset.idx;
      const el = document.getElementById("diff-file-" + idx);
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
    };
  });

  // Wire collapsible file headers
  overlay.querySelectorAll(".diff-file-header").forEach(header => {
    header.onclick = () => {
      const idx = header.dataset.idx;
      const hunks = overlay.querySelector(`.diff-hunks[data-idx="${idx}"]`);
      const arrow = header.querySelector(".arrow");
      if (hunks) hunks.classList.toggle("hidden");
      if (arrow) arrow.classList.toggle("collapsed");
    };
  });
}

// Escape key closes diff overlay
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeDiffOverlay();
});

// --- utils ---
function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }
function ago(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return "just now";
  if (s < 3600) return `${Math.floor(s / 60)}m ago`;
  if (s < 86400) return `${Math.floor(s / 3600)}h ago`;
  return `${Math.floor(s / 86400)}d ago`;
}

connect();

// --- Screen Wake Lock ---
let wakeLock = null;
async function requestWakeLock() {
  try {
    if ("wakeLock" in navigator) {
      wakeLock = await navigator.wakeLock.request("screen");
      wakeLock.addEventListener("release", () => { wakeLock = null; });
    }
  } catch {}
}
requestWakeLock();
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") requestWakeLock();
});
</script>
</body>
</html>
